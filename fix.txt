Meridian OSS - Comprehensive Work Plan (Updated)
Executive Summary
After thorough end-to-end analysis of the updated repository against PRD.md and epic_plan.md requirements, I identified 55+ issues across 7 categories. The codebase has significantly improved with the addition of new modules (events, worker, embeddings, context, graph, retrieval, doctor) implementing most of the epic plan phases.

PRD & Epic Plan Validation Summary
✅ Implemented (Epic Plan Phases)
Phase	Status	Evidence
Phase 1: Event Wedge	✅ Complete	events.py, bus.py, worker.py
Phase 2: Managed Indexing	✅ Complete	index.py, embeddings.py, postgres.py (pgvector)
Phase 3: Intelligent Assembly	✅ Complete	context.py, retrieval.py, graph.py
Phase 4: Observability	✅ Complete	observability.py, models.py (ContextTrace), /context/{id}/explain API
Phase 5: Time Travel	✅ Complete	postgres.py:get_historical_features(), test_time_travel.py
FR-3.2: Implicit DAG Wiring	✅ Complete	graph.py, retrieval.py:_resolve_args(), test_dag_wiring.py
⚠️ Partially Implemented
Requirement	Status	Gap
FR-1.3: At-least-once Delivery	⚠️ Partial	No dead letter queue implementation
FR-2.3: Deduplication	⚠️ Partial	content_hash exists but no explicit dedup test
NFR-2: P99 < 50ms	⚠️ Partial	test_latency_bench.py exists but limited scope
NFR-4: Graceful Degradation	⚠️ Partial	Circuit breaker exists but no fallback chain test
❌ Not Implemented / Missing
Requirement	Status	Notes
FR-5.2: Change Audit Log	❌ Missing	No governance/audit trail system
NFR-5: Zero-Downtime Deploy	❌ Not validated	No rolling deployment test
Phase 1: Critical Bugs (Fix Immediately)
1.1 Closure Bug in Scheduler Job Registration
File: src/meridian/core.py:177
Problem: Lambda captures name variable by reference, not by value. All scheduled jobs will materialize the last feature due to Python's late binding.

for name, feature in self.registry.features.items():
    if feature.materialize and feature.refresh:
        self.scheduler.schedule_job(
            func=lambda: self._materialize_feature(name),  # BUG

Tasks:

 Change to capture by value: func=lambda n=name: self._materialize_feature(n)
 Add test to verify each job materializes correct feature
1.2 Redundant Store Assignment in AxiomWorker
File: src/meridian/worker.py:15-17, 48
Problem: self.store is assigned twice, first to None then to store parameter.

def __init__(self, ...):
    self.store: Optional[FeatureStore] = None  # Line 15
    if store:
        self.store = store  # Line 17
    ...
    self.store = store  # Line 48 - OVERWRITES regardless!

Tasks:

 Remove line 48: self.store = store (redundant/overwrites logic)
1.3 Duplicate Store Assignment in test_disaster.py
File: tests/e2e/test_disaster.py:20-21
Problem: Store created twice in same line.

store = RedisOnlineStore(f"redis://{host}:{port}")
store = RedisOnlineStore(f"redis://{host}:{port}")  # DUPLICATE

Tasks:

 Remove duplicate line 21
1.4 Missing f-string Log Warning
File: src/meridian/graph.py:79
Problem: Uses f-string directly in warning call instead of structured logging.

logger.warning(f"Feature {feat_name} not found in registry")

Tasks:

 Change to: logger.warning("feature_not_found", feature=feat_name)
1.5 Async Function Call Without Await in Retrieval
File: src/meridian/retrieval.py:116
Problem: func(*args, **kwargs) in sync wrapper doesn't await if func is coroutine.

return cast(List[Dict[str, Any]], list(func(*args, **kwargs)))

Tasks:

 Ensure sync wrapper only used for sync functions (already guarded by inspect.iscoroutinefunction check, but the early return bypasses the async wrapper - verify logic flow)
Phase 2: Security Issues
2.1 Potential SQL Injection in Index Table Name
File: src/meridian/store/postgres.py:204, 212-226, 284
Problem: index_name is interpolated directly into table names without validation.

table_name = f"meridian_index_{index_name}"  # Unsafe

Tasks:

 Add validation: if not re.match(r'^[a-zA-Z_][a-zA-Z0-9_]*$', index_name): raise ValueError(...)
 Apply same validation in add_documents() and search() methods
2.2 Deprecated datetime.utcnow() Usage
Files: src/meridian/models.py:16, src/meridian/store/postgres.py:265
Problem: datetime.utcnow() is deprecated in Python 3.12+.

created_at: datetime = Field(default_factory=datetime.utcnow, ...)

Tasks:

 Replace with datetime.now(timezone.utc) throughout
2.3 Missing Input Validation on event_type
File: src/meridian/server.py:93
Problem: event_type path parameter used directly without validation.

Tasks:

 Add validation for alphanumeric event types
2.4 Potential Memory Leak in Anthropic Token Counter
File: src/meridian/utils/tokens.py:56-57
Problem: @lru_cache on method with self reference may leak memory.

@functools.lru_cache(maxsize=1024)
def _cached_count(self, text: str) -> int:

Tasks:

 Use functools.cached_property or cache on class variable instead
 Or clear cache on instance deletion
Phase 3: Code Quality Improvements
3.1 Print Statement in store/offline.py
File: src/meridian/store/offline.py:79 (if still present after user changes)
Problem: Uses print() instead of logger for errors.

Tasks:

 Replace with logger.warning() or logger.error()
3.2 Inconsistent Logging Import
File: src/meridian/worker.py:3
Problem: Uses logging module while rest of codebase uses structlog.

import logging
logger = logging.getLogger(__name__)

Tasks:

 Replace with import structlog and logger = structlog.get_logger()
3.3 Magic Numbers in Scheduler
File: src/meridian/scheduler_dist.py:32, 36
Problem: Hardcoded jitter (1.0s) and lock TTL multiplier (0.9).

Tasks:

 Extract to constants:
MAX_JITTER_SECONDS = 1.0
LOCK_TTL_MULTIPLIER = 0.9

3.4 Duplicate Comment in core.py
File: src/meridian/core.py:107-108
Problem: Duplicate comment line.

Tasks:

 Remove duplicate
3.5 Unused Import in context.py
File: src/meridian/context.py:3
Problem: Check for any unused imports.

Tasks:

 Run ruff check and fix any unused import warnings
3.6 Missing Type Annotation
File: src/meridian/doctor.py:146
Problem: toml_loader typed as Any instead of proper type.

Tasks:

 Use Optional[types.ModuleType] or Protocol
Phase 4: Missing Tests
4.1 Event System Tests (Phase 1 Completeness)
Gap: Missing dead letter queue test (FR-1.3)

Tasks:

 Add test for message retry on failure
 Add test for dead letter queue behavior
 Test worker graceful shutdown
4.2 Indexing Tests (Phase 2 Completeness)
Gap: Missing deduplication verification test

Tasks:

 Add test for ON CONFLICT DO NOTHING behavior
 Add test for same content re-ingestion
4.3 Context Assembly Tests (Phase 3 Completeness)
Gap: Missing edge cases

Tasks:

 Test ContextBudgetError handling when all items are required
 Test cache invalidation via dependency:{source_id} keys
 Test staleness detection with max_staleness parameter
4.4 Time Travel Tests (Phase 5 Completeness)
Gap: Only mock tests exist

Tasks:

 Add integration test with real Postgres container
 Test point-in-time retrieval with multiple feature versions
4.5 DAG Wiring Tests
Gap: Missing failure mode tests

Tasks:

 Test when feature computation fails mid-DAG
 Test circular dependency detection (if supported)
 Test sync retriever with template (should warn)
4.6 Doctor Command Tests
Current: Only smoke tests

Tasks:

 Test with missing dependencies
 Test with invalid URLs
 Test with actual Redis/Postgres connections (integration)
Phase 5: CI/CD & Infrastructure
5.1 Add Test Coverage Upload
File: .github/workflows/ci.yml

Tasks:

 Add Codecov or Coveralls integration:
- name: Upload coverage
  uses: codecov/codecov-action@v3
  with:
    fail_ci_if_error: true

5.2 Add Integration Test Job
File: .github/workflows/ci.yml

Tasks:

 Add separate job with services for integration tests:
integration:
  services:
    redis:
      image: redis:7
    postgres:
      image: postgres:15

5.3 Release Workflow Improvements
File: .github/workflows/release.yml

Tasks:

 Add test execution before publish
 Add semver validation
 Add GitHub Release creation with changelog
5.4 Dockerfile Health Check
File: Dockerfile

Tasks:

 Add HEALTHCHECK instruction:
HEALTHCHECK --interval=30s --timeout=3s \
  CMD curl -f http://localhost:8000/health || exit 1

5.5 Add .dockerignore
Tasks:

 Create .dockerignore:
.git
.venv
__pycache__
*.pyc
.coverage
.pytest_cache
tests/
docs/

Phase 6: Documentation Updates
6.1 Missing API Documentation
Tasks:

 Document /ingest/{event_type} endpoint in API reference
 Document /context/{context_id}/explain endpoint
 Document meridian worker CLI command
 Document meridian doctor CLI command
6.2 Missing Architecture Documentation
Tasks:

 Add sequence diagram for event-driven feature updates
 Add diagram for DAG resolution flow
 Document pgvector index schema
6.3 Environment Variables Documentation
Tasks:

 Create comprehensive env vars reference:
MERIDIAN_ENV
MERIDIAN_REDIS_URL
MERIDIAN_POSTGRES_URL
MERIDIAN_API_KEY
OPENAI_API_KEY
COHERE_API_KEY
6.4 Missing Use Case Documentation
Tasks:

 Add RAG example using @retriever and @context
 Add event-driven feature update example
 Add time travel query example
Phase 7: Feature Enhancements
7.1 Dead Letter Queue (FR-1.3 Completion)
File: src/meridian/worker.py

Tasks:

 Add DLQ stream: meridian:events:{event_type}:dlq
 Move failed messages to DLQ after N retries
 Add meridian dlq status CLI command
7.2 Audit Trail (FR-5.2 Implementation)
Not Implemented

Tasks:

 Create AuditLog model with operation, timestamp, actor
 Log feature updates to audit table
 Add /audit/{entity_id} API endpoint
7.3 Graceful Shutdown Improvements
Files: worker.py, scheduler.py

Tasks:

 Register SIGTERM handlers
 Wait for in-flight jobs to complete
 Add shutdown timeout configuration
7.4 Connection Pool Metrics
Tasks:

 Add meridian_redis_pool_size gauge
 Add meridian_postgres_pool_size gauge
 Add meridian_worker_active_jobs gauge
7.5 Cache Invalidation API
File: src/meridian/server.py

Tasks:

 Add DELETE /cache/{pattern} endpoint
 Implement systemic invalidation (already in test_systemic_invalidation.py)
